= Red Hat JBoss Data Grid xPaaS Image
{product-author}
{product-version}
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:

toc::[]

== Overview

Red Hat JBoss Data Grid is available as a containerized xPaaS image that is designed for use with OpenShift.  This image provides an in-memory distributed database so that developers can quickly access large amounts of data in a hybrid environment.

[IMPORTANT]
There are significant differences in supported configurations and functionality
in the JBoss Data Grid xPaaS image compared to the regular release of JBoss Data Grid.

This topic details the differences between the JBoss Data Grid xPaaS image and the
regular release of JBoss Data Grid, and provides instructions specific to running and
configuring the JBoss Data Grid xPaaS image. Documentation for other JBoss Data Grid
functionality not specific to the JBoss Data Grid xPaaS image can be found in the
https://access.redhat.com/documentation/en/red-hat-jboss-data-grid/[JBoss
Data Grid documentation on the Red Hat Customer Portal].

== Comparing the JBoss Data Grid xPaaS Image to the Regular Release of JBoss Data Grid

=== Functionality Differences for OpenShift JBoss Data Grid xPaaS Images

There are several major functionality differences in the OpenShift JBoss Data Grid xPaaS image:

* The JBoss Data Grid Management Console is not available link:#Managing-OpenShift-JBoss-Data-Grid-xPaaS-Images[to manage OpenShift JBoss Data Grid xPaaS images].
* The JBoss Data Grid Management CLI is only bound locally. This means that you can only access the Management CLI of a container from within the pod.
* Library mode is not supported.
* Only JDBC is supported for a backing cache-store.  Support for remote cache stores are present only for data migration purposes.

[[Clustering]]
=== Forming a Cluster using the OpenShift JBoss Data Grid xPaaS Images

All images deployed to the same project will automatically form a cluster,
discovering the other nodes in the cluster using UDP as normal.  A cluster
may not include nodes across multiple projects, but may be accessed outside
the project using either REST or HotRod endpoints.

As additional images are deployed they will automatically join the cluster;
however, removing images from an active cluster, and therefore shrinking the cluster,
is not supported.

[[Endpoints]]
=== Endpoints

Clients can access JBoss Data Grid via REST, HotRod, and memcached endpoints defined as usual in the cache's configuration.

If a client attempts to access a cache via HotRod and is in the same project it will be able to receive 
the full cluster view and make use of consistent hashing; however, if it is in another project then the
client will unable to receive the cluster view.  Additionally, if the client is located outside of the
project that contains the HotRod cache there will be additional latency due to extra network hops
being required to access the cache. 

[IMPORTANT]
Only caches with an exposed REST endpoint will be accessible outside of OpenShift.

[[Managing-OpenShift-JBoss-Data-Grid-xPaaS-Images]]
=== Managing OpenShift JBoss Data Grid xPaaS Images

A major difference in managing an OpenShift JBoss Data Grid xPaaS image is that there is no Management Console exposed for the JBoss Data Grid installation inside the image. Because images are intended to be immutable, with modifications being written to a non-persistent file system, the Management Console is not exposed.

However, the JBoss Data Grid Management CLI (*_JDG_HOME/bin/jboss-cli.sh_*) is still
accessible from within the container for troubleshooting purposes. 

1. First open a remote shell session to the running pod:
+
----
$ oc rsh <pod_name>
----
+
2. Then run the following from the remote shell session to launch the JBoss Data Grid
Management CLI:
+
----
$ /opt/datagrid/bin/jboss-cli.sh
----

[WARNING]
Any configuration changes made using the JBoss Data Grid Management CLI on a running container will be lost when the container restarts.

link:#Making-Configuration-Changes-Data-Grid[Making configuration changes to the
JBoss Data Grid instance inside the JBoss Data Grid xPaaS image] is different from the process you may be used to for a regular release of JBoss Data Grid.

== Installing the JBoss Data Grid xPaaS Image Streams and Application Templates

To use the Red Hat xPaaS middleware images in your OpenShift project, you must
first
link:../../install_config/install/first_steps.html#creating-image-streams-for-xpaas-middleware-images[install
the image streams] and
link:../../install_config/install/first_steps.html#creating-instantapp-templates[Source-to-Image
(S2I) application templates].

[[Making-Configuration-Changes-Data-Grid]]
== Running and Configuring the JBoss Data Grid xPaaS Image

You can make changes to the JBoss Data Grid configuration in the xPaaS image using either the S2I templates, or by using a modified JBoss Data Grid xPaaS image.

=== Using the JBoss Data Grid xPaaS Image Source-to-Image (S2I) Process

The recommended method to run and configure the OpenShift JBoss Data Grid xPaaS image is to use the OpenShift S2I process together with the application template parameters and environment variables.

The S2I process for the JBoss Data Grid xPaaS image works as follows:

. If there is a *_pom.xml_* file in the source repository, a Maven build is triggered with the contents of `*$MAVEN_ARGS*` environment variable.
+
. By default the `package` goal is used with the `openshift` profile, including the system properties for skipping tests (`*-DskipTests*`) and enabling the Red Hat GA repository (`*-Dcom.redhat.xpaas.repo.redhatga*`).
+
. The results of a successful Maven build are copied to *_JDG_HOME/standalone/deployments_*. This includes all JAR, WAR, and EAR files from the directory within the source repository specified by `*$ARTIFACT_DIR*` environment variable. The default value of `*$ARTIFACT_DIR*` is the *_target_* directory.
* Any JAR, WAR, and EAR in the *_deployments_* source repository directory are copied to the *_JDG_HOME/standalone/deployments_* directory.
* All files in the *_configuration_* source repository directory are copied to *_JDG_HOME/standalone/configuration_*.
+
[NOTE]
If you want to use a custom JBoss Data Grid configuration file, it should be named *_clustered-openshift.xml_*.
. All files in the *_modules_* source repository directory are copied to *_JDG_HOME/modules_*.

==== Using a Different JDK Version in the JBoss Data Grid xPaaS Image

The JBoss Data Grid xPaaS image may come with multiple versions of OpenJDK installed, but only one is the default. For example, the JBoss Data Grid 6.5 xPaaS image comes with OpenJDK 1.7 and 1.8 installed, but OpenJDK 1.8 is the default.

If you want the JBoss Data Grid xPaaS image to use a different JDK version than the default, you must:

* Ensure that your *_pom.xml_* specifies to build your code using the intended JDK version.
* In the S2I application template, configure the image's `*JAVA_HOME*` environment variable to point to the intended JDK version. For example:
+
----
{
  "name": "JAVA_HOME",
  "value": "/usr/lib/jvm/java-1.7.0"
}
----

=== Using a Modified JBoss Data Grid xPaaS Image

An alternative method is to make changes to the image, and then use that modified image in OpenShift.

The JBoss Data Grid configuration file that OpenShift uses inside the JBoss Data Grid xPaaS image is *_JDG_HOME/standalone/configuration/clustered-openshift.xml_*, and the JBoss Data Grid startup script is *_JDG_HOME/bin/openshift-launch.sh_*.

You can run the JBoss Data Grid xPaaS image in Docker, make the required configuration changes using the JBoss Data Grid Management CLI (*_JDG_HOME/bin/jboss-cli.sh_*), and then commit the changed container as a new image. You can then use that modified image in OpenShift.

[IMPORTANT]
It is recommended that you do not replace the OpenShift placeholders in the JBoss Data Grid xPaaS configuration file, as they are used to automatically configure services (such as messaging, datastores, HTTPS) during a container's deployment. These configuration values are intended to be set using environment variables.

[NOTE]
Ensure that you follow the   link:../../creating_images/guidelines.html[guidelines for creating images].

[[Variables]]
== Environment Variables

The following environment variables are designed to conveniently adjust the image without requiring a rebuild:

[options="header"]
|====================================
| Variable Name | Description | Value
| *_JAVA_OPTS_APPEND_* | The contents of *_JAVA_OPTS_APPEND_* is appended to *_JAVA_OPTS_* on startup. | Example: *_-Dfoo=bar_*
| *_JDG_USERNAME_* | Username for JDG user. | Example: *_openshift_*
| *_JDG_PASSWORD_* | Password for JDG user. | Example: *_p@ssw0rd_*
| *_JDG_SECDOMAIN_NAME_* | Security domain name. | Example: *_jdg-openshift_*
| *_JDG_SIMPLE_AUTHENTICATION_* | Flag if simple authentication is to be used (true/false) | Example: *_true_*
| *_JGROUPS_CLUSTER_PASSWORD_* | A password to control access to JGroups.  Needs to be set consistently cluster-wide.  The image default is to use the *_OPENSHIFT_KUBE_PING_LABELS_* variable value; however, the JBoss application templates generate and supply a random value. | Example: *_miR0JaDR_*
| *_OPENSHIFT_KUBE_PING_LABELS_* | Clustering labels selector. | Example: *_application=eap-app_*
| *_OPENSHIFT_KUBE_PING_NAMESPACE_* | Clustering project namespace. | Example: *_myproject_*
|====================================


[[Troubleshooting]]
== Troubleshooting

In addition to viewing the OpenShift logs, you can troubleshoot a running JBoss Data Grid xPaaS Image container by viewing its logs. These are outputted to the containerâ€™s standard out, and are accessible with the following command:

----
$ oc logs -f <pod_name> <container_name>
----

[NOTE]
By default, the OpenShift JBoss Data Grid xPaaS image does not have a file log handler configured. Logs are only sent to the container's standard out.
