// Module included in the following assemblies:
//
// * storage/persistent-storage-ceph.adoc

[id='ceph-volume-{context}']
= Creating the Persistent Volume

Developers request Ceph RBD storage by referencing either a PVC, or the 
Gluster volume plug-in directly in the volumes section of a Pod 
specification. A PVC exists only in the userâ€™s namespace and can be 
referenced only by Pods within that same namespace. Any attempt to 
access a PV from a different namespace causes the pod to fail.

. Define the PV in an object definition before creating it in 
{product-title}:
+
.Persistent Volume Object Definition Using Ceph RBD
[source,yaml]
----
apiVersion: v1
kind: PersistentVolume
metadata:
  name: ceph-pv <1>
spec:
  capacity:
    storage: 2Gi <2>
  accessModes:
    - ReadWriteOnce <3>
  rbd: <4>
    monitors: <5>
      - 192.168.122.133:6789
    pool: rbd
    image: ceph-image
    user: admin
    secretRef:
      name: ceph-secret <6>
    fsType: ext4 <7>
    readOnly: false
  persistentVolumeReclaimPolicy: Retain
----
<1> The name of the PV that is referenced in pod definitions or displayed 
in various `oc` volume commands.
<2> The amount of storage allocated to this volume.
<3> `accessModes` are used as labels to match a PV and a PVC. They 
currently do not define any form of access control. All block storage is 
defined to be single user, or non-shared storage.
<4> The volume type being used, in this case the `rbd` plug-in.
<5> An array of Ceph monitor IP addresses and ports.
<6> The Ceph Secret used to create a secure connection from {product-title}
to the Ceph server.
<7> The file system type mounted on the Ceph RBD block device.
+
[IMPORTANT]
====
Changing the value of the fstype parameter after the volume has been 
formatted and provisioned can result in data loss and pod failure.
====
. Save your definition to a file, for example `ceph-pv.yaml`.
. Create the PV from the saved file:
+
----
oc create -f ceph-pv.yaml
----
. Verify that the persistent volume was created:
+
----
oc get pv
NAME                     LABELS    CAPACITY     ACCESSMODES   STATUS      CLAIM     REASON    AGE
ceph-pv                  <none>    2147483648   RWO           Available                       2s
----

. Create a PVC that will bind to the new PV:
+
.PVC Object Definition
[source,yaml]
----
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: ceph-claim
spec:
  accessModes: <1>
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi <2>
----
<1> The `accessModes` do not enforce access right, but instead act as 
labels to match a PV to a PVC.
<2> This claim looks for PVs offering `2Gi` or greater capacity.

. Save the PVC definition to a file, such as `ceph-claim.yaml`.
. Create the PVC:
+
----
oc create -f ceph-claim.yaml
----
